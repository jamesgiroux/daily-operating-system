# Mechanical Gates — Entity Resolution + Room + Context Scoping

**Problem:** Intelligence leaks between entities. A Cox B2B meeting shows Jefferies/Agentforce signals. The Room shows AI-enriched stakeholders, not calendar invitees. Entity resolution treats multi-entity people (CSMs) as introducing competing entities rather than reinforcing the primary hypothesis.

**Principle:** Mechanical signals first. Hypothesis-and-reinforce, not collect-all-possibilities.

---

## 1. The Room = Calendar Invitees Only

**Current:** `KeyPeopleFlow` renders `meeting.prep.stakeholders` — an AI-enriched list that may include people who weren't invited.

**Fix:** The Room renders from the raw calendar attendee list, not from prep stakeholders. The attendee data already exists on the meeting — it's the Google Calendar attendees array.

### Backend
- `schedule.json` meeting objects already have an `attendees` field (from Google Calendar API)
- Ensure this field includes: name, email, RSVP status (accepted/tentative/declined/needsAction)
- The `CalendarEvent` struct in types.rs already has `attendees: Vec<String>` — but it may only have email strings, not structured attendee data

**Check:** What format does the Google Calendar API return attendees in? The `populate_people_from_events()` function in `google.rs` processes attendees. We need name + email + RSVP status per attendee.

### Frontend
- `BriefingMeetingCard` expansion panel: replace `meeting.prep.stakeholders` with `meeting.attendees` (structured)
- The Room component groups by internal/external using email domain (compare against user's org domain from config)
- Show RSVP status: accepted = normal, tentative = muted, declined = don't show, needsAction = muted with "?"
- Role/title: look up from `people` table if the person exists there. Otherwise just show name + company (from email domain)

### What moves OUT of The Room
- AI-enriched stakeholder insights → stay on MeetingDetailPage "The Room" chapter (the full intelligence report)
- Temperature dots → removed (already done in previous commit)
- People not on the invite → not shown

---

## 2. Calendar Description as Primary Context

**Current:** The expansion panel shows `meeting.prep.context` (AI-generated narrative) truncated.

**Fix:** If the meeting has a calendar description, show it FIRST as the organizer's stated purpose. AI narrative comes second.

### Frontend
- Check `meeting.calendarNotes` or similar field for the Google Calendar event description
- If present: render it in the expansion panel before the AI narrative
- Style: DM Sans 14px, normal weight, primary text color. Not italic — this is the organizer's words, not the system's.
- AI narrative (prep.context): render below, in italic serif, as editorial commentary

### Backend
- Verify `schedule.json` includes the calendar event description
- Check `deliver_schedule()` — does it write the description field?

---

## 3. Entity Resolution: Hypothesis-and-Reinforce Model

**Current model (collect-all-possibilities):**
1. Junction table → Cox B2B (0.95)
2. Attendee domains → Cox (0.80), Jefferies (0.80), Salesforce (0.80)
3. Keywords → Agentforce (0.55)
4. All candidates enter a HashMap, best wins by confidence

**Problem:** A Jefferies person at a Cox meeting creates a 0.80 Jefferies candidate. A Salesforce person creates a 0.80 Salesforce candidate. These compete with Cox B2B even though the meeting is clearly about Cox.

**New model (hypothesis-and-reinforce):**

### Phase 1: Form the hypothesis
Pick the strongest initial signal as the hypothesis:
1. Manual junction table link → definitive (confidence 0.95+)
2. If no junction: external domain majority → strong hypothesis
3. If no clear domain: title keyword match → moderate hypothesis

### Phase 2: Reinforce or challenge
For each attendee, check their entity associations:
- **If attendee is linked to the hypothesized entity** → reinforcement (+0.05 per person, capped)
- **If attendee is linked to a DIFFERENT entity but is a multi-entity person** (CSM, partner SE) → neutral (they're here because of the hypothesized entity)
- **If attendee is linked to a DIFFERENT entity and is NOT multi-entity** → mild challenge (-0.02 but doesn't override the hypothesis)

### Phase 3: Only challenge the hypothesis if competing evidence is overwhelming
The hypothesis can only be overridden if:
- 3+ attendees from a competing entity domain AND no junction table link AND no title match for the hypothesis
- This is the "actually this meeting is about Jefferies, not Cox" case — rare but possible

### Implementation in `entity_resolver.rs`

```rust
pub fn resolve_meeting_entities_v2(
    db: &ActionDb,
    event_id: &str,
    meeting: &Value,
    accounts_dir: &Path,
    embedding_model: Option<&EmbeddingModel>,
) -> Vec<ResolutionOutcome> {
    // 1. Check junction table first (definitive)
    let junction_entities = get_junction_entities(db, event_id);
    if !junction_entities.is_empty() {
        // Junction is definitive — return it, don't run further resolution
        return junction_entities;
    }

    // 2. Form hypothesis from strongest mechanical signal
    let hypothesis = form_hypothesis(db, meeting, accounts_dir);

    // 3. Check if attendees reinforce or challenge the hypothesis
    let reinforced = reinforce_hypothesis(db, &hypothesis, meeting);

    // 4. Return the reinforced hypothesis (or revised if overwhelming counter-evidence)
    reinforced
}
```

### Key change: Junction table is DEFINITIVE
If a meeting has a manual junction table link, entity resolution STOPS. No attendee-based resolution, no keyword matching, no embedding similarity. The user said "this meeting is about Cox B2B" — respect that.

### Multi-entity people (CSMs, partner SEs)
When checking an attendee's entity associations:
```rust
let person_entities = db.get_person_entity_links(&person_id);
if person_entities.len() > 1 {
    // Multi-entity person — they're at this meeting because of the hypothesized entity
    // Their presence is neutral, not a competing signal
    if person_entities.iter().any(|e| e.entity_id == hypothesis.entity_id) {
        // Reinforcement: they're linked to the hypothesis
        hypothesis.confidence += 0.05;
    }
    // Don't add their other entities as candidates
} else if person_entities.len() == 1 {
    let linked_entity = &person_entities[0];
    if linked_entity.entity_id == hypothesis.entity_id {
        hypothesis.confidence += 0.05;
    } else {
        // Single-entity person linked to a different entity — mild challenge
        hypothesis.confidence -= 0.02;
        // But still don't override unless overwhelming evidence
    }
}
```

---

## 4. AI Enrichment Scoped to Linked Entity

**Current:** The AI prompt includes all attendee information and the AI synthesizes freely about any entity it recognizes.

**Fix:** The AI enrichment prompt must include a scoping instruction:

```
This meeting is about {entity_name}.
Only surface intelligence relevant to {entity_name}.
Do not generate intelligence about other companies or entities
mentioned in the attendee list. Attendees from other organizations
are present in a partner/vendor/consultant capacity.
```

### Implementation
In `meeting_context.rs` or wherever the AI enrichment prompt is built:
- Add the scoping constraint after the calendar description
- The entity name comes from the primary resolved entity
- This is a prompt-level gate, not a code-level filter

---

## 5. BU-Aware Entity Resolution

**Current:** Entity resolution doesn't consider BU (Business Unit) associations.

**Fix:** When an attendee is linked to a person in the people table, and that person is linked to a BU, the BU's parent account is a strong entity signal:

```rust
// Attendee → Person → BU → Account
if let Some(person) = db.get_person_by_email(&attendee_email) {
    if let Some(bu_id) = person.business_unit_id {
        if let Some(bu) = db.get_business_unit(&bu_id) {
            // The BU's parent account is a strong signal
            add_candidate(bu.account_id, confidence: 0.85, source: "bu_association");
        }
    }
}
```

---

## Implementation: 3 agents

### Agent `resolver` (Backend — entity_resolver.rs, meeting_context.rs)
- Implement hypothesis-and-reinforce model in entity_resolver.rs
- Junction table is definitive — stop resolution if junction exists
- Multi-entity people reinforce, don't diversify
- Add AI scoping constraint to enrichment prompt
- BU-aware entity signal

### Agent `room` (Frontend — BriefingMeetingCard.tsx)
- The Room renders calendar attendees, not prep.stakeholders
- Group by internal/external using email domain
- Show RSVP status
- Look up role from people table when available

### Agent `context` (Backend + Frontend — schedule delivery, calendar description)
- Ensure calendar description flows through to schedule.json
- Frontend: show description prominently in expansion panel before AI narrative
- Verify attendee data includes name + email + RSVP in schedule.json

---

## Verification

- Meeting manually linked to Cox B2B shows ONLY Cox B2B intelligence
- Attendees from Jefferies/Salesforce appear in The Room (they were invited) but don't leak entity intelligence
- CSM linked to 3 accounts doesn't introduce 3 entity candidates
- Calendar description appears prominently when present
- AI narrative is scoped to the linked entity
