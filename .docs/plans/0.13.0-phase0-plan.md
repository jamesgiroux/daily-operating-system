# Phase 0: Entity-Generic Cleanup — Agent Team Plan

**Status:** Much lighter than originally estimated. Migration 023 already shipped, `Meeting` struct already uses `linkedEntities`, entity resolver is entity-generic.

**Remaining work:** Clean up ~12 backward-compat `account` references on meeting-related structs, update 3 React components, clarify schema documentation.

---

## Audit Summary

| Item | Status |
|------|--------|
| Migration 023 (drop `meetings_history.account_id`) | Already applied |
| `Meeting` struct → `linkedEntities` | Already migrated (I52) |
| Entity resolver (I305) | Already entity-generic |
| `DirectiveMeeting.account` | Legacy field, kept for backward compat (Python directives) |
| `DirectiveMeetingContext.entity_id/entity_type` | Already entity-generic (I337) |
| `DbAction.account_id`, `DbCapture.account_id` etc. | Legitimate — actions/captures belong to accounts |

## What Actually Needs to Change

### Track A: Rust Type Cleanup (3 files)

**1. `src-tauri/src/types.rs`**
- `WeekMeeting.account` (line ~910): Remove field, consumers should use `linked_entities` (line ~918)
- `WeekAction.account` (line ~956): Mark `#[deprecated]` or remove if no consumers
- `FocusMeeting.account` (line ~1098): Add `linked_entities: Option<Vec<LinkedEntity>>` field alongside
- `CalendarEvent.account` (line ~1527): Add `linked_entities: Option<Vec<LinkedEntity>>` field alongside

**2. `src-tauri/src/workflow/deliver.rs`**
- `find_meeting_entry()` (line ~190): Returns `m.account.clone()` — update to also return entities
- `deliver_schedule()`: Ensure schedule.json writes `linkedEntities` array alongside `account` for backward compat
- `build_prep_json()` (line ~1392): Already uses I337 primary_entity; verify `entities` array is written to prep JSON

**3. `src-tauri/src/json_loader.rs`**
- `JsonMeeting.account` (line ~119): Add `linked_entities: Option<Vec<LinkedEntity>>` for entity-generic schedule parsing
- Ensure `from_schedule_json()` populates `linked_entities` from schedule.json data

### Track B: Frontend Cleanup (4 files)

**1. `src/types/index.ts`**
- `WeekMeeting.account` (line ~274): Remove or mark `@deprecated`, ensure `linkedEntities` is the canonical field
- `FocusMeeting.account`: Add `linkedEntities?: LinkedEntity[]`

**2. `src/pages/weekPageViewModel.ts`**
- Line ~297: `m.account` → use `m.linkedEntities?.[0]?.name` or entity-aware display

**3. `src/components/PostMeetingPrompt.tsx`**
- Lines 93, 131: `meeting.account` → use entity from linked entities or passed context

**4. `templates/schemas/schedule.schema.json`**
- Lines 58-61: Add `linkedEntities` array to schema, mark `account` as deprecated

### Track C: Verification

- `cargo test` — all pass
- `cargo clippy -- -D warnings` — clean
- `npx tsc --noEmit` — clean
- `pnpm test` — all pass
- Grep: `WeekMeeting` consumers don't read `.account`
- Grep: `FocusMeeting` consumers don't read `.account`

---

## Team Structure: 2 Agents in Parallel

### Agent `rust-cleanup` (Track A)
- Read and modify `types.rs`, `deliver.rs`, `json_loader.rs`
- Must read each file first to find exact line numbers
- Preserve backward compat: keep `account` fields on directive types (Python produces them), add `linked_entities` alongside
- Remove `account` from output types that already have `linked_entities` (`WeekMeeting`)

### Agent `frontend-cleanup` (Track B)
- Read and modify `types/index.ts`, `weekPageViewModel.ts`, `PostMeetingPrompt.tsx`, `schedule.schema.json`
- Remove or deprecate `account` on `WeekMeeting` and `FocusMeeting` types
- Update component consumers to use `linkedEntities`

### Lead runs Track C after both agents complete.

---

## What We're NOT Changing

- `DbAction.account_id` — Legitimate. Actions belong to accounts.
- `DbCapture.account_id` — Legitimate. Captures belong to accounts.
- `DbAccountTeamMember.account_id` — Legitimate. Team members belong to accounts.
- `DirectiveMeeting.account` — Keep for backward compat with existing directive JSON files.
- `DirectiveMeetingContext.account` — Keep as fallback; `entity_id`/`entity_type` takes precedence.
- `Action.account` display field — Legitimate display context.
- `HygieneAlert.account` — Display name, not data model.
- `ReadinessCheck.account_id` — Entity ID reference, correctly named.
